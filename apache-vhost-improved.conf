<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName labo.sekrane.fr
    ServerAlias www.labo.sekrane.fr
    DocumentRoot /var/www/labo.sekrane.fr

    # Configuration proxy générale
    ProxyPreserveHost On
    ProxyRequests Off
    # Configuration des timeouts pour SSE
    ProxyTimeout 3600
    ProxyBadHeader Ignore

    # Configuration spécifique pour SSE
    <Location "/api/notifications/ws">
        ProxyPass http://localhost:8006/api/notifications/ws
        ProxyPassReverse http://localhost:8006/api/notifications/ws
        
        # Désactiver la mise en cache
        Header always set Cache-Control "no-cache, no-store, must-revalidate"
        Header always set Pragma "no-cache"
        Header always set Expires "0"
        
        # Désactiver le buffering pour les réponses en streaming
        SetEnv proxy-nokeepalive 1
        SetEnv proxy-sendchunked 1
    </Location>
    
    # Configuration proxy pour le reste de l'application
    ProxyPass /api/notifications/ws !
    ProxyPass / http://localhost:8006/
    ProxyPassReverse / http://localhost:8006/

    
    # Configuration des timeouts
    Timeout 300
    KeepAlive On
    KeepAliveTimeout 65
    MaxKeepAliveRequests 1000
    
    # Headers de sécurité
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set Referrer-Policy strict-origin-when-cross-origin
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
    
    # Configuration de compression (exclure SSE)
    <IfModule mod_deflate.c>
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf)$ \
            no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            ^/api/notifications/ws no-gzip dont-vary
    </IfModule>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/labo_error.log
    CustomLog ${APACHE_LOG_DIR}/labo_access.log combined
    LogLevel warn
    
    # SSL Configuration
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/labo.sekrane.fr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/labo.sekrane.fr/privkey.pem

</VirtualHost>
</IfModule>

# Redirection HTTP vers HTTPS
<VirtualHost *:80>
    ServerName labo.sekrane.fr
    ServerAlias www.labo.sekrane.fr
    Redirect permanent / https://labo.sekrane.fr/
</VirtualHost>
