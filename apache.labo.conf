# Apache vhost configuration for labo.sekrane.fr with WebSocket support
# Place (or symlink) into /etc/apache2/sites-available/labo.conf then:
#   a2enmod proxy proxy_http proxy_wstunnel headers rewrite http2 ssl
#   a2ensite labo.conf
#   systemctl reload apache2

<VirtualHost *:80>
  ServerName labo.sekrane.fr
  ServerAlias www.labo.sekrane.fr
  DocumentRoot /var/www/labo.sekrane.fr

  # Redirect all HTTP to HTTPS
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  ErrorLog ${APACHE_LOG_DIR}/labo_error.log
  CustomLog ${APACHE_LOG_DIR}/labo_access.log combined
</VirtualHost>


# Apache vhost configuration for labo.sekrane.fr with WebSocket support
# Place (or symlink) into /etc/apache2/sites-available/labo.conf then:
#   a2enmod proxy proxy_http proxy_wstunnel headers rewrite http2 ssl
#   a2ensite labo.conf
#   systemctl reload apache2

<VirtualHost *:80>
  ServerName labo.sekrane.fr
  ServerAlias www.labo.sekrane.fr
  DocumentRoot /var/www/labo.sekrane.fr

  # Redirect all HTTP to HTTPS
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  ErrorLog ${APACHE_LOG_DIR}/labo_error.log
  CustomLog ${APACHE_LOG_DIR}/labo_access.log combined
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
  ServerName labo.sekrane.fr
  ServerAlias www.labo.sekrane.fr
  DocumentRoot /var/www/labo.sekrane.fr

  # Backend Next+WS server
  # Node server listens on 8007 (scripts/ws-server.ts)
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-Port "443"

  # WebSocket path
  ProxyPass /ws ws://localhost:8007/ws nocanon
  ProxyPassReverse /ws ws://localhost:8007/ws

  # Regular HTTP traffic
  ProxyPass / http://localhost:8007/ retry=0
  ProxyPassReverse / http://localhost:8007/

  # Préserve l'en-tête Host pour que l'app voie "labo.sekrane.fr"
  ProxyPreserveHost On
  
  # Ensure Upgrade headers are forwarded for all potential websocket requests
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteCond %{HTTP:Connection} upgrade [NC]
  RewriteRule ^/ws/(.*) ws://localhost:8007/ws/$1 [P,L]

  <Location /ws>
    ProxyPreserveHost On
  </Location>

  Protocols h2 http/1.1

  ErrorLog ${APACHE_LOG_DIR}/labo_error.log
  CustomLog ${APACHE_LOG_DIR}/labo_access.log combined

  Include /etc/letsencrypt/options-ssl-apache.conf
  SSLCertificateFile /etc/letsencrypt/live/labo.sekrane.fr/fullchain.pem
  SSLCertificateKeyFile /etc/letsencrypt/live/labo.sekrane.fr/privkey.pem
</VirtualHost>
</IfModule>
