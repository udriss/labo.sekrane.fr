generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String          @id @default(cuid())
  email             String          @unique
  password          String
  name              String
  role              Role            @default(STUDENT)
  class             String?
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  auditLogs         AuditLog[]
  createdNotebooks  NotebookEntry[] @relation("CreatedBy")
  orders            Order[]
  assignedNotebooks NotebookEntry[] @relation("AssignedTo")
  customClasses     UserClass[]
  createdTPPresets  TpPreset[]

  @@map("users")
}

model UserClass {
  id       String @id @default(cuid())
  userId   String
  className String
  createdAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, className])
  @@map("user_classes")
}

model SecurityEvent {
  id        Int      @id @default(autoincrement())
  eventType String
  timestamp DateTime @default(now())
}

model Chemical {
  id              String             @id @default(cuid())
  name            String
  formula         String?
  molfile         String?
  casNumber       String?
  barcode         String?            @unique
  quantity        Float
  unit            Unit
  minQuantity     Float?
  concentration   Float?
  purity          Float?
  purchaseDate    DateTime?
  expirationDate  DateTime?
  openedDate      DateTime?
  storage         String?
  room            String?
  cabinet         String?
  shelf           String?
  hazardClass     HazardClass?
  sdsFileUrl      String?
  supplierId      String?
  batchNumber     String?
  orderReference  String?
  status          ChemicalStatus     @default(IN_STOCK)
  notes           String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  supplier        Supplier?          @relation(fields: [supplierId], references: [id])
  usedInNotebooks NotebookChemical[]
  orderItems      OrderItem[]
  tpPresets       TpPresetChemical[]

  @@map("chemicals")
}

model Materiel {
  id               String              @id @default(cuid())
  name             String
  type             EquipmentType
  model            String?
  serialNumber     String?             @unique
  barcode          String?             @unique
  quantity         Int
  status           EquipmentStatus     @default(AVAILABLE)
  location         String?
  room             String?
  cabinet          String?
  lastMaintenance  DateTime?
  nextMaintenance  DateTime?
  maintenanceNotes String?
  supplierId       String?
  purchaseDate     DateTime?
  warrantyEnd      DateTime?
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  supplier         Supplier?           @relation(fields: [supplierId], references: [id])
  maintenanceLogs  MaintenanceLog[]
  usedInNotebooks  NotebookEquipment[]
  orderItems       OrderItem[]
  tpPresets        TpPresetMaterial[]

  @@map("materiel")
}

model MaintenanceLog {
  id          String          @id @default(cuid())
  equipmentId String
  date        DateTime
  type        MaintenanceType
  description String
  cost        Float?
  performedBy String
  createdAt   DateTime        @default(now())
  materiel   Materiel       @relation(fields: [equipmentId], references: [id])

  @@map("maintenance_logs")
}

model Supplier {
  id        String      @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  website   String?
  notes     String?
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  chemicals Chemical[]
  materiel Materiel[]
  orders    Order[]

  @@map("suppliers")
}

model Order {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  supplierId   String
  userId       String
  status       OrderStatus @default(DRAFT)
  orderDate    DateTime?
  deliveryDate DateTime?
  totalAmount  Float?
  notes        String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  items        OrderItem[]
  supplier     Supplier    @relation(fields: [supplierId], references: [id])
  user         User        @relation(fields: [userId], references: [id])

  @@map("orders")
}

model OrderItem {
  id          String     @id @default(cuid())
  orderId     String
  chemicalId  String?
  equipmentId String?
  quantity    Float
  unitPrice   Float?
  totalPrice  Float?
  notes       String?
  chemical    Chemical?  @relation(fields: [chemicalId], references: [id])
  materiel   Materiel? @relation(fields: [equipmentId], references: [id])
  order       Order      @relation(fields: [orderId], references: [id])

  @@map("order_items")
}

model NotebookEntry {
  id              String              @id @default(cuid())
  title           String
  description     String?
  protocolFileUrl String?
  scheduledDate   DateTime
  duration        Int?
  class           String
  groups          String[]
  createdById     String
  objectives      String?
  procedure       String?
  observations    String?
  results         String?
  calculations    String?
  conclusions     String?
  images          String[]
  attachments     String[]
  studentSigned   Boolean             @default(false)
  teacherSigned   Boolean             @default(false)
  signedAt        DateTime?
  status          NotebookStatus      @default(DRAFT)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  chemicals       NotebookChemical[]
  createdBy       User                @relation("CreatedBy", fields: [createdById], references: [id])
  materiel       NotebookEquipment[]
  assignedTo      User[]              @relation("AssignedTo")

  @@map("notebook_entries")
}

model NotebookChemical {
  id           String        @id @default(cuid())
  notebookId   String
  chemicalId   String
  quantityUsed Float
  unit         Unit
  notes        String?
  chemical     Chemical      @relation(fields: [chemicalId], references: [id])
  notebook     NotebookEntry @relation(fields: [notebookId], references: [id])

  @@map("notebook_chemicals")
}

model NotebookEquipment {
  id          String        @id @default(cuid())
  notebookId  String
  equipmentId String
  quantity    Int           @default(1)
  notes       String?
  materiel   Materiel     @relation(fields: [equipmentId], references: [id])
  notebook    NotebookEntry @relation(fields: [notebookId], references: [id])

  @@map("notebook_equipment")
}

model Calendar {
  id          String       @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  class       String?
  room        String?
  type        CalendarType
  notebookId  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("calendar_events")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  entityType String
  entityId   String
  oldData    Json?
  newData    Json?
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  user       User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Location {
  id        String   @id @default(cuid())
  name      String   @unique
  room      String?
  cabinet   String?
  shelf     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("locations")
}

model ConfigurableList {
  id         String   @id @default(cuid())
  type       String   // 'hazard_class', 'storage_condition', 'room', etc.
  value      String
  isActive   Boolean  @default(true)
  sortOrder  Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([type, value])
  @@map("configurable_lists")
}

model Room {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true)
  locations   RoomLocation[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("rooms")
}

model RoomLocation {
  id          String   @id @default(cuid())
  roomId      String
  name        String   // "Armoire A", "Étagère 1", etc.
  description String?
  isActive    Boolean  @default(true)
  room        Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([roomId, name])
  @@map("room_locations")
}

model TpPreset {
  id               String                @id @default(cuid())
  title            String
  description      String?
  objectives       String?
  procedure        String?
  duration         Int?                  // Durée en minutes
  level            String?               // Niveau scolaire
  subject          String?               // Matière
  isActive         Boolean               @default(true)
  createdById      String
  attachments      String[]              // URLs des fichiers joints
  chemicals        TpPresetChemical[]
  materials        TpPresetMaterial[]
  createdBy        User                  @relation(fields: [createdById], references: [id])
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@map("tp_presets")
}

model TpPresetChemical {
  id           String        @id @default(cuid())
  tpPresetId   String
  chemicalId   String
  quantityUsed Float
  unit         Unit
  notes        String?
  chemical     Chemical      @relation(fields: [chemicalId], references: [id])
  tpPreset     TpPreset      @relation(fields: [tpPresetId], references: [id], onDelete: Cascade)

  @@map("tp_preset_chemicals")
}

model TpPresetMaterial {
  id          String        @id @default(cuid())
  tpPresetId  String
  materialId  String
  quantity    Int           @default(1)
  notes       String?
  material    Materiel      @relation(fields: [materialId], references: [id])
  tpPreset    TpPreset      @relation(fields: [tpPresetId], references: [id], onDelete: Cascade)

  @@map("tp_preset_materials")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

enum Unit {
  mL
  L
  g
  kg
  mg
  mol
  piece
}

enum ChemicalStatus {
  IN_STOCK
  LOW_STOCK
  OPENED
  EXPIRED
  EMPTY
  QUARANTINE
}

enum HazardClass {
  EXPLOSIVE
  FLAMMABLE
  OXIDIZING
  TOXIC
  CORROSIVE
  IRRITANT
  CARCINOGENIC
  ENVIRONMENTAL
}

enum EquipmentType {
  GLASSWARE
  HEATING
  MEASURING
  SAFETY
  MIXING
  FILTRATION
  OPTICAL
  ELECTRONIC
  OTHER
}

enum EquipmentStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  BROKEN
  RETIRED
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  CALIBRATION
  CLEANING
}

enum OrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum NotebookStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model PresetChemical {
  id               String   @id @default(cuid())
  name             String
  formula          String?
  casNumber        String?  @unique
  molarMass        Float?   // g/mol
  boilingPoint     Float?   // °C
  meltingPoint     Float?   // °C
  density          Float?   // g/cm³
  hazardClass      HazardClass?
  categories       ChemicalCategory[]
  physicalState    PhysicalState @default(LIQUID)
  safetyNotes      String?
  commonUses       String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("preset_chemicals")
}

model ChemicalCategory {
  id               String          @id @default(cuid())
  name             String          @unique
  description      String?
  color            String?         // Couleur hex pour l'affichage
  sortOrder        Int?
  isActive         Boolean         @default(true)
  presetChemicals  PresetChemical[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@map("chemical_categories")
}

enum CalendarType {
  TP
  MAINTENANCE
  INVENTORY
  OTHER
}

enum PhysicalState {
  SOLID
  LIQUID
  GAS
  PLASMA
}
